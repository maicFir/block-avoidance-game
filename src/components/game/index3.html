<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>躲避积木</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      canvas {
        background: #f0f0f0;
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <div>source: <span id="source"></span></div>
    <div>Remaining Life: <span id="life"></span></div>
    <canvas id="gameCanvas"></canvas>
    <script>
      const sourceDom = document.getElementById("source");
      const lifeDom = document.getElementById("life");
      const canvas = document.getElementById("gameCanvas");

      const ctx = canvas.getContext("2d");
      canvas.width = 800; // 设置画布宽度
      canvas.height = 600; // 设置画布高度

      // 角色类
      class Character {
        constructor(x, y) {
          this.x = x;
          this.y = y;
          this.width = 50;
          this.height = 50;
          this.speed = 5;
          this.velocityY = 0; // 重力的速度
          this.gravity = 0.5; // 重力大小
          this.lives = 3; // 生命数量
          lifeDom.innerText = this.lives;
        }

        move(left, right) {
          if (left) this.x -= this.speed;
          if (right) this.x += this.speed;
        }

        jump() {
          if (this.y === canvas.height - this.height) {
            // 确保只有在地面上时可以跳跃
            this.velocityY = -15;
          }
        }

        update() {
          this.y += this.velocityY;
          if (this.y < canvas.height - this.height) {
            this.velocityY += this.gravity;
          } else {
            this.y = canvas.height - this.height; // 防止角色掉出画面
            this.velocityY = 0;
          }
        }

        draw() {
          ctx.fillStyle = "blue";
          ctx.fillRect(this.x, this.y, this.width, this.height);
        }
      }

      // 坠落物体类
      class FallingObject {
        constructor() {
          this.x = Math.random() * canvas.width;
          this.y = 0;
          this.size = Math.random() * 30 + 20; // 随机物体大小
          this.speed = Math.random() * 3 + 2; // 随机物体下落速度
        }

        update() {
          this.y += this.speed;
        }

        draw() {
          ctx.fillStyle = "red";
          ctx.fillRect(this.x, this.y, this.size, this.size);
        }

        checkCollision(character) {
          if (
            this.x < character.x + character.width &&
            this.x + this.size > character.x &&
            this.y < character.y + character.height &&
            this.y + this.size > character.y
          ) {
            return true; // 发生碰撞
          }
          return false;
        }
      }

      const character = new Character(
        canvas.width / 2 - 25,
        canvas.height - 50
      );
      const fallingObjects = [];
      let score = 0;
      let gameOver = false;
      let left = false,
        right = false;

      function gameLoop() {
        if (gameOver) return alert("游戏结束！得分: " + score);

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 控制角色
        character.move(left, right);
        character.update();
        character.draw();

        // 添加和更新掉落物体
        if (Math.random() < 0.05) {
          fallingObjects.push(new FallingObject());
        }

        fallingObjects.forEach((object, index) => {
          object.update();
          object.draw();

          if (object.checkCollision(character)) {
            character.lives -= 1;
            lifeDom.innerText = character.lives;
            fallingObjects.splice(index, 1); // 移除已碰撞的物体
            if (character.lives <= 0) {
              gameOver = true;
            }
          }
        });

        // 更新分数
        score += 1;
        sourceDom.innerText = score;
        requestAnimationFrame(gameLoop);
      }

      // 监听键盘事件
      window.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") left = true;
        if (e.key === "ArrowRight") right = true;
        if (e.key === " " || e.key === "ArrowUp") character.jump();
      });
      window.addEventListener("keyup", (e) => {
        if (e.key === "ArrowLeft") left = false;
        if (e.key === "ArrowRight") right = false;
      });

      // 启动游戏
      gameLoop();
    </script>
  </body>
</html>
